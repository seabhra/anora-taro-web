<script>
// ===================================================================
// SCRIPT PRINCIPAL - ORÃCULO ANORA TARÃ” (VERSÃƒO FINAL CORRIGIDA)
// ===================================================================

let hasReading = false;
let isResetting = false;

// Ãudio de fundo global para o App Inventor
window.memoriesAudio = new Audio('https://image2url.com/r2/default/audio/1767545788311-beeb40af-197a-4a99-9469-c723887f8b07.mp3');
window.memoriesAudio.loop = true;

// FunÃ§Ã£o global para parar o Ã¡udio
window.stopAudioNativo = function() {
    if (window.memoriesAudio) {
        window.memoriesAudio.pause();
        window.memoriesAudio.currentTime = 0;
    }
};

// Monitor para comandos do App Inventor
setInterval(function() {
    if (window.AppInventor) {
        let comando = window.AppInventor.getWebViewString();
        if (comando === "PARAR") {
            window.stopAudioNativo();
            window.AppInventor.setWebViewString("");
        }
    }
}, 500);

document.addEventListener('DOMContentLoaded', () => {

  // ---------------- ELEMENTOS DO DOM ----------------      
  const button = document.getElementById('actionButton');
  const status = document.getElementById('status');
  const loader = document.getElementById('loader');
  const aiBox = document.getElementById('aiBox');
  const promptBox = document.getElementById('promptBox');
  const florBox = document.getElementById('florBox');
  const cabalaBox = document.getElementById('cabalaBox');
  const pageLoader = document.getElementById('pageLoader');

  const imgs = [
    document.getElementById('card1'),
    document.getElementById('card2'),
    document.getElementById('card3')
  ].filter(Boolean);

  const labels = [
    document.getElementById('name1'),
    document.getElementById('name2'),
    document.getElementById('name3')
  ].filter(Boolean);

  // ---------------- ESTADO ----------------
  const basePath = 'cards_images/';
  const backCard = basePath + 'back.jpg';

  // ---------------- ÃUDIO ----------------
    
  const shuffleAudio = new Audio('Audio_app/slots_machine.mp3');
  shuffleAudio.preload = 'auto';      

  // ---------------- CARTAS ----------------
  const cards = [
    { label:'Louco', file:'01_Louco' }, { label:'Mago', file:'02_Mago' },
    { label:'Sacerdotisa', file:'03_Sacerdotisa' }, { label:'Imperatriz', file:'04_Imperatriz' },
    { label:'Imperador', file:'05_Imperador' }, { label:'Sacerdote', file:'06_Sacerdote' },
    { label:'Amantes', file:'07_Amantes' }, { label:'Carro', file:'08_Carro' },
    { label:'ForÃ§a', file:'09_Forca' }, { label:'Eremita', file:'10_Eremita' },
    { label:'Roda da Fortuna', file:'11_Roda' }, { label:'JustiÃ§a', file:'12_Justica' },
    { label:'Enforcado', file:'13_Enforcado' }, { label:'Morte', file:'14_Morte' },
    { label:'TemperanÃ§a', file:'15_Temperanca' }, { label:'Diabo', file:'16_Diabo' },
    { label:'Torre', file:'17_Torre' }, { label:'Estrela', file:'18_Estrela' },
    { label:'Lua', file:'19_Lua' }, { label:'Sol', file:'20_Sol' },
    { label:'Julgamento', file:'21_Julgamento' }, { label:'Mundo', file:'22_Mundo' }
  ];

  // ---------------- FUNÃ‡Ã•ES ----------------
  const shuffle = arr => arr.sort(() => Math.random() - 0.5);

  function newReading() {
    // Prepara o Ã¡udio de fundo
    window.memoriesAudio.play().then(() => {
        window.memoriesAudio.pause();
        window.memoriesAudio.currentTime = 0;
    }).catch(e => console.log("Ãudio preparado"));

    if (florBox) florBox.style.display = 'none';
    
    // Mostra a imagem da cabala
    if (cabalaBox) {
      cabalaBox.style.display = 'flex';
      cabalaBox.style.justifyContent = 'center';
      cabalaBox.style.alignItems = 'center';
    }

    aiBox.style.display = 'none';
    promptBox.style.display = 'none';
    loader.style.display = 'none';
      
    shuffleAudio.currentTime = 0;
    shuffleAudio.play().catch(() => {});

    button.className = 'action-button roxo';
    button.innerHTML = `<span class="status-emoji giro">ðŸŒ€</span><span class="status-text">Embaralhando Cartas</span>`;
    status.textContent = 'Sua previsÃ£o em andamento...';
    status.className = 'status-process';

    imgs.forEach(img => img.classList.add('card-spinning'));
    labels.forEach(l => l.innerText = 'Sorteando');

    const spin = setInterval(() => {
      imgs.forEach(img => {
        const r = cards[Math.floor(Math.random() * cards.length)];
        img.src = `${basePath}${r.file}.jpg`;
      });
    }, 80);

    setTimeout(() => {
      clearInterval(spin);
      shuffleAudio.pause();

      const drawn = shuffle([...cards]).slice(0, 3);
      drawn.forEach((c, i) => {
        imgs[i].src = `${basePath}${c.file}.jpg`;
        labels[i].innerText = c.label;
        imgs[i].classList.remove('card-spinning');
      });

      loader.style.display = 'block';
      status.innerHTML = `<span class="status-emoji">ðŸ¤–</span><span class="status-text">Processando consulta com IA...</span>`;
      status.className = 'status-loading'; 

      callAuroraAPI(drawn.map(c => c.label));

      hasReading = true;
      button.className = 'action-button blue';
      button.innerHTML = `<span class="btn-emoji">ðŸ”„</span><span class="status-text">Nova Consulta</span>`;
      cabalaBox && (cabalaBox.style.display = 'none');
      showPrompt(drawn.map(c => c.label));
    }, 7500);
  }

  function showPrompt(drawn) {
    const pBox = document.getElementById('promptBox');
    if (pBox) {
      const cardNamesHtml = drawn.map(name => `<span class="prompt-card-name">${name}</span>`).join('');
      const termsHtml = `
        <span style="color: #6b46c1; font-weight: normal;">Passado</span>
        <span style="color: #6b46c1; font-weight: normal;">Presente</span>
        <span style="color: #6b46c1; font-weight: normal;">Futuro</span>
      `;
      
      pBox.innerHTML = `
       <p style="margin-top: 12px; color: #7fa3f3; font-weight: bold;">ðŸ“œ Cartas selecionadas pela IA:</p>
        <div class="prompt-container">
          ${cardNamesHtml}
          ${termsHtml}
        </div>
      `;
      
      pBox.style.display = 'block';
    }
  }

  function clearPrompt() {
    if (!promptBox) return;
    promptBox.innerHTML = '';
    promptBox.style.display = 'none';
  }
        
  function resetReading() {
    isResetting = true;
    imgs.forEach(img => img.src = backCard);
    labels.forEach(l => l.innerText = '');
    clearPrompt();
    aiBox.style.display = 'none';
    loader.style.display = 'none';
    if (cabalaBox) cabalaBox.style.display = 'none';
    florBox && (florBox.style.display = 'flex');
    
    button.innerHTML = `<span class="btn-emoji">ðŸ”®</span><span>Embaralhar Cartas</span>`;
    button.className = 'action-button pink';
    button.disabled = false;
    status.innerHTML = `<span class="status-text">Aguardando sua consulta...</span>`;
    status.className = '';
    
    const adContainer = document.getElementById('ad-container');
    if (adContainer) adContainer.style.display = 'none';

    window.memoriesAudio.pause();
    window.memoriesAudio.currentTime = 0;       

    hasReading = false;
    isResetting = false;
  }
        
  function shareOnWhatsApp() {
    const title = document.querySelector('#aiBox h2')?.innerText?.trim() || 'Anora TarÃ´';
    const analysisText = document.querySelector('#aiBox p')?.innerText?.trim() || '';

    if (!analysisText) {
      console.warn('Nenhum texto de anÃ¡lise encontrado para compartilhar.');
      return;
    }
    const WHATSAPP_FOOTER = "\n\nðŸ”® Anora TarÃ´ â€” leitura assistida por IA\nâš¡ Powered by Geraldo A. Seabra";
    const message = `âœ¨ ${title}\n\n${analysisText}${WHATSAPP_FOOTER}`;

    try {
      if (window.AppInventor && typeof window.AppInventor.setWebViewString === 'function') {
        window.AppInventor.setWebViewString(message);
      } else {
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
      }
    } catch (error) {
      console.error("Erro ao tentar compartilhar no WhatsApp:", error);
    }
  }

  // >>> FUNÃ‡ÃƒO DA API CORRIGIDA <<<
  async function callAuroraAPI(cardsDrawn) {
    try {
      // CORREÃ‡ÃƒO 1: Usar a URL completa da API.
      const res = await fetch('/api/chat', {

      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [{
          role: "user",
          content: `Interprete as cartas ${cardsDrawn.join(', ')}`
        }]
      })
    });


          

      if (!res.ok) {
          throw new Error(`Erro de rede: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();
      if (isResetting) return;
      
      const text = data.choices?.[0]?.message?.content || 'A IA nÃ£o retornou nenhuma anÃ¡lise.';

      // Monta o HTML uma Ãºnica vez
      aiBox.innerHTML = `
        <h2 class="ai-title">
          <img src="cards_images/marca_anora.png" class="ai-logo">
          Anora Assistente de IA
        </h2>
        <div id="aiResponseContent" style="text-align: justify; overflow: hidden;">
          <button id="shareButton" onclick="shareOnWhatsApp()" style="display: flex;">
              <img src="cards_images/zap.png" alt="Compartilhar">
          </button>
          <p style="margin: 0; line-height: 1.6; color: #333;">${text}</p>
        </div>
        <div id="ad-container">
          <span style="font-size: 10px; color: #999; margin-bottom: 5px;">Publicidade</span>
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-3940256099942544"
               data-ad-slot="6300978111"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>
      `;

      status.innerHTML = `<span class="status-emoji">âœ…</span><span class="status-text">Consulta realizada com sucesso</span>`;
      status.className = 'status-success';
      
      // Toca o Ã¡udio de memÃ³rias
      window.memoriesAudio.volume = 0.5;
      window.memoriesAudio.play().catch(err => console.error("Erro ao tocar Ã¡udio de memÃ³ria:", err));

    } catch (error) {
      console.error('Erro na chamada da API:', error);
      aiBox.innerHTML = `<p>Erro ao acessar a reflexÃ£o. Tente novamente.</p>`;
      status.textContent = 'Erro de carregamento';
      status.className = 'status-error';
    }

    loader.style.display = 'none';
    aiBox.style.display = 'block';

    // Ativa o AdMob
    const adContainer = document.getElementById('ad-container');
    if (adContainer) {
        adContainer.style.display = 'flex';
        setTimeout(() => {
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                console.error("Erro ao tentar carregar o anÃºncio:", e);
            }
        }, 300);
    }
  }
        
  // ---------------- EVENTOS ----------------
  if (button) {
    button.onclick = () => hasReading ? resetReading() : newReading();
  }

  document.addEventListener('click', (event) => {
    if (event.target && event.target.id === 'shareButton') {
      shareOnWhatsApp();
    }
  });

  window.addEventListener('load', () => {
    setTimeout(() => pageLoader?.classList.add('hidden'), 1500);
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .catch(err => console.warn('SW erro:', err));
  }
});
</script>
